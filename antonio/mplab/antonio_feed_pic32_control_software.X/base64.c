#include "base64.h"

unsigned char decode_tbl[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 00 - 07
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 08 - 0f
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 10 - 17
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 18 - 1f
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 20 - 27
  0x00, 0x00, 0x00, 0x3e, 0x00, 0x00, 0x00, 0x3f,  // 28 - 2f
  0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b,  // 30 - 37
  0x3c, 0x3d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 38 - 3f
  0x00, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06,  // 40 - 47
  0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e,  // 48 - 4f
  0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16,  // 50 - 57
  0x17, 0x18, 0x19, 0x00, 0x00, 0x00, 0x00, 0x00,  // 58 - 5f
  0x00, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,  // 60 - 67
  0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,  // 68 - 6f
  0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,  // 70 - 77
  0x31, 0x32, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00,  // 78 - 7f
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 80 - 87
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 88 - 8f
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 90 - 97
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // 98 - 9f
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // a0 - a7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // a8 - af
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // b0 - b7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // b8 - bf
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // c0 - c7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // c8 - cf
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // d0 - d7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // d8 - df
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // e0 - e7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // e8 - ef
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // f0 - f7
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00   // f8 - ff
};

unsigned int base64_decode(char* out, char* in) {
    unsigned int outi = 0;
    unsigned char state = 0;

    while (*in) {
        if (*in == '=') {
            break;
        }
        switch (state) {
            case 0:
                out[outi] = (decode_tbl[*in] << 2) & 0xfc;
                break;
            case 1:
                out[outi] |= ((decode_tbl[*in] >> 4) & 0x03);
                outi++;
                out[outi] = ((decode_tbl[*in] << 4) & 0xf0);
                break;
            case 2:
                out[outi] |= ((decode_tbl[*in] >> 2) & 0x0f);
                outi++;
                out[outi] = ((decode_tbl[*in] << 6) & 0xc0);
                break;
            case 3:
                out[outi] |= (decode_tbl[*in] & 0x3f);
                outi++;
                break;
        }
        state = (state + 1) & 0x03;
        in++;
    }
    out[outi] = 0;
    return (outi);
}